import os
import sys
import json
import operator
from model.film import Film
from model.frame import Frame
from PIL import Image, ImageDraw 
import math 

# Cree un objet film avec le json en parametre
def LoadData(jsonPath):
    with open(jsonPath) as film_file:
        jsFilm = json.load(film_file)
        movieFrame =[]
        for jsFrame in jsFilm["frames"]:
            movieFrame.append(Frame(jsFrame["num"],jsFrame["primalColor"]))
        film=Film(jsFilm["titre"],movieFrame)
    return film

# Retourne le path de tout les fichier json sous  le dossier en parametrer
def GetAllJsonPath(directoryPath):
    allJsonPath =[]

    for file in os.listdir(directoryPath):
        path=os.path.join(directoryPath, file)
        if(os.path.isdir(path)): 
            allJsonPath += GetAllVideoPath(path)              
        else :
            if file.endswith((".json")) :                
                allJsonPath.append(path) 

    return allJsonPath

# Retourne une image(PILLOW) du film
def DrawShapeOfMovie(movie):    
    orderedFrame = sorted(movie.frames, key=operator.attrgetter("num"))

    w, h = len(orderedFrame)/4,len(orderedFrame)
      # creating new Image object 
    img = Image.new("RGB", (w, h)) 

    for movieFrame in orderedFrame:
        # create line image
        shape = [(0,movieFrame.num), (w, movieFrame.num)]          
        img1 = ImageDraw.Draw(img)   
        img1.line(shape, fill ="#{}".format(movieFrame.primalColor), width = 0) 


    return img     

# Main methode de la partie exploit
def Exploit(directoryMoviePath,dataDirectoryPath,outputPath):

    allJsonPath=GetAllJsonPath(outputPath)

    for jsonPath in allJsonPath:
        monFilm=LoadData(jsonPath)
        imgTitre="{}.png".format(monFilm.titre)
        img = DrawShapeOfMovie(monFilm)
        img.save(os.path.join(outputPath, imgTitre),"JPEG")